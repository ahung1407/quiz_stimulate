<!DOCTYPE html>
<html lang="vi">
{# Lưu ý: File này được render bởi Flask, không phải str.format() #}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aaa</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #f8f9fa; --correct-color: #28a745;
            --incorrect-color: #dc3545; --text-color: #212529; --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 2rem;
        }
        .quiz-container {
            max-width: 900px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .quiz-header {
            padding: 20px 30px; background-color: var(--primary-color); color: white; text-align: center;
        }
        .quiz-header h2 { margin: 0; font-size: 1.5em; }
        .quiz-body { padding: 30px; }
        .question-block { margin-bottom: 2.5rem; border-bottom: 1px solid #eee; padding-bottom: 1.5rem; }
        .question-block:last-child { border-bottom: none; }
        .question-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .question-text { font-size: 1.2em; font-weight: 600; margin-bottom: 15px; line-height: 1.5; flex-grow: 1; }
        .options-container { display: flex; flex-direction: column; gap: 15px; }
        .option {
            background-color: #fff; border: 2px solid var(--border-color); border-radius: 10px;
            padding: 15px; cursor: pointer; transition: all 0.2s ease-in-out;
            display: flex; align-items: center;
        }
        .option:hover { border-color: var(--primary-color); }
        .option.correct { background-color: #e9f7ec; border-color: var(--correct-color); color: var(--correct-color); font-weight: bold; }
        .option.incorrect { background-color: #fdecea; border-color: var(--incorrect-color); color: var(--incorrect-color); font-weight: bold; }
        .option-key {
            font-weight: bold; margin-right: 15px; min-width: 20px; height: 20px;
            display: inline-flex; justify-content: center; align-items: center;
        }
        .quiz-footer { padding: 20px 30px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; }
        .btn, .radio-label {
            padding: 12px 25px; border: none; border-radius: 8px; font-size: 1em;
            font-weight: bold; cursor: pointer; color: white; transition: background-color 0.2s;
        }
        #confirm-btn { background-color: var(--primary-color); }
        #confirm-btn:hover { background-color: #0056b3; }
        #confirm-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #next-btn { background-color: var(--correct-color); }
        #next-btn:hover { background-color: #218838; }        
        .explanation-container { margin-top: 15px; padding: 15px; background-color: #f1f3f5; border-radius: 10px; border-left: 5px solid var(--primary-color); line-height: 1.6; }
        #explanation-container strong { color: var(--primary-color); }
        .results-container { padding: 40px; text-align: center; }
        .results-container h2 { font-size: 2em; margin-bottom: 20px; }
        .results-container p { font-size: 1.5em; margin-bottom: 30px;}
        .hidden { display: none; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center; 
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 600px; border-radius: 10px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-bottom: 15px;}
        .modal-header h3 { margin: 0; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;}
        .close-btn:hover, .close-btn:focus { color: black;}
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-body select, .modal-body textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
        .modal-body textarea { min-height: 100px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #dee2e6; padding-top: 15px; margin-top: 15px; }
        .radio-label { background-color: #fff; border: 2px solid var(--border-color); color: var(--text-color); }
        .radio-label:hover { border-color: var(--primary-color); }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { border-color: var(--primary-color); background-color: #e7f3ff; }
    </style>
</head>
<body>
    <div class="quiz-container" id="quiz-container">
        <div class="quiz-header">
            <h2 id="quiz-title">aaa</h2>
        </div>
        <div class="quiz-body">
            <div id="quiz-content-wrapper"></div>
        </div>
        <div class="quiz-footer">
            <button class="btn" id="check-all-btn" style="background-color: var(--correct-color);">Kiểm tra tất cả</button>
        </div>
    </div>

    <!-- Suggestion Modal -->
    <div id="suggestion-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Góp ý/Sửa đổi câu hỏi</h3>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p>Cảm ơn bạn đã giúp cải thiện bộ câu hỏi. Vui lòng cung cấp đáp án và giải thích mà bạn cho là đúng.</p>
                <div class="form-group">
                    <label for="new-answer">Đáp án đúng mới:</label>
                    <select id="new-answer">
                        <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-explanation">Giải thích mới:</label>
                    <textarea id="new-explanation" placeholder="Nhập giải thích mới của bạn ở đây..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="submit-suggestion-btn" class="btn" style="background-color: var(--primary-color);">Gửi góp ý</button>
            </div>
        </div>
    </div>

    <script>
        // Dữ liệu được truyền trực tiếp từ Flask
        let quizData = [];
        
        const modal = document.getElementById('suggestion-modal');
        const closeModalBtn = document.querySelector('.close-btn');
        const submitSuggestionBtn = document.getElementById('submit-suggestion-btn');
        const checkAllBtn = document.getElementById('check-all-btn');
        let currentEditingQuestionId = null;

        async function loadAndRenderQuiz() {
            try {
                const jsonFilename = 's---aaa.json';
                const res = await fetch(jsonFilename);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                quizData = await res.json();
                renderQuiz();
            } catch (error) {
                console.error("Lỗi khi tải quiz:", error);
                document.getElementById('quiz-content-wrapper').innerHTML = `<strong>Lỗi tải dữ liệu!</strong>`;
            }
        }

        function renderQuiz() {
            const wrapper = document.getElementById('quiz-content-wrapper');
            wrapper.innerHTML = ''; // Xóa nội dung cũ
            quizData.forEach((question, index) => {
                const questionBlock = document.createElement('div');
                questionBlock.className = 'question-block';
                questionBlock.id = `q-${question.id}`;

                let optionsHTML = '';
                const sortedOptions = Object.keys(question.options).sort();
                for (const key of sortedOptions) {
                    const value = question.options[key];
                    optionsHTML += `
                        <input type="radio" name="q${question.id}" id="q${question.id}-${key}" value="${key}">
                        <label for="q${question.id}-${key}" class="radio-label">
                            <span class="option-key">${key}</span>
                            <span>${value}</span>
                        </label>
                    `;
                }

                questionBlock.innerHTML = `
                    <div class="question-header">
                        <p class="question-text">${index + 1}. ${question.question}</p>
                        <button class="btn btn-sm btn-secondary copy-question-btn" data-id="${question.id}">Copy</button>
                    </div>
                    <div class="options-container">
                        ${optionsHTML}
                    </div>
                    <div style="text-align: right; margin-top: 1rem;">
                        <button class="btn btn-sm check-single-btn" data-id="${question.id}" style="background-color: var(--primary-color);">Kiểm tra</button>
                    </div>
                    <div class="explanation-container hidden" id="exp-${question.id}"></div>
                `;
                wrapper.appendChild(questionBlock);
            });

            // Gắn lại sự kiện sau khi render
            attachEventListeners();
        }

        function checkSingleAnswer(questionId) {
            const question = quizData.find(q => q.id === questionId);
            if (!question) return;

            const questionBlock = document.getElementById(`q-${question.id}`);
            const selectedOption = questionBlock.querySelector(`input[name="q${question.id}"]:checked`);
            const explanationDiv = questionBlock.querySelector('.explanation-container');
            const options = questionBlock.querySelectorAll('.radio-label');

            if (!selectedOption) {
                alert('Vui lòng chọn một đáp án trước khi kiểm tra.');
                return;
            }

            // Hiển thị giải thích
            explanationDiv.innerHTML = `<strong>Đáp án đúng: ${question.answer}</strong><br>${question.explanation}` +
                `<br><button class="btn btn-sm btn-secondary suggest-btn" data-id="${question.id}" style="margin-top: 10px;">Góp ý/Sửa đổi</button>`;
            explanationDiv.classList.remove('hidden');

            // Tô màu đáp án đúng
            options.forEach(label => {
                const key = label.getAttribute('for').split('-')[1];
                if (key === question.answer) {
                    label.classList.add('correct');
                }
            });

            // Tô màu đáp án sai của người dùng
            if (selectedOption.value !== question.answer) {
                const wrongLabel = document.querySelector(`label[for="${selectedOption.id}"]`);
                if (wrongLabel) wrongLabel.classList.add('incorrect');
            }

            // Vô hiệu hóa các lựa chọn cho câu hỏi này
            questionBlock.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
            questionBlock.querySelector('.check-single-btn').style.display = 'none'; // Ẩn nút kiểm tra
        }

        function checkAllAnswers() {
            let score = 0;
            quizData.forEach(question => {
                const selectedOption = document.querySelector(`input[name="q${question.id}"]:checked`);
                const explanationDiv = document.getElementById(`exp-${question.id}`);
                const questionBlock = document.getElementById(`q-${question.id}`);
                const options = questionBlock.querySelectorAll('.radio-label');

                if (selectedOption) {
                    // Chỉ kiểm tra những câu chưa được kiểm tra riêng lẻ
                    if (!explanationDiv.classList.contains('hidden')) {
                        if (selectedOption.value === question.answer) score++;
                        return;
                    }

                    explanationDiv.innerHTML = `<strong>Đáp án đúng: ${question.answer}</strong><br>${question.explanation}` +
                        `<br><button class="btn btn-sm btn-secondary suggest-btn" data-id="${question.id}" style="margin-top: 10px;">Góp ý/Sửa đổi</button>`;
                    explanationDiv.classList.remove('hidden');

                    options.forEach(label => {
                        const key = label.getAttribute('for').split('-')[1];
                        if (key === question.answer) label.classList.add('correct');
                    });

                    if (selectedOption.value === question.answer) {
                        score++;
                    } else {
                        const wrongLabel = document.querySelector(`label[for="${selectedOption.id}"]`);
                        if (wrongLabel) wrongLabel.classList.add('incorrect');
                    }
                }
            });

            document.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
            document.querySelectorAll('.check-single-btn').forEach(btn => btn.style.display = 'none');
            
            alert(`Bạn đã trả lời đúng ${score} / ${quizData.length} câu!`);
            checkAllBtn.textContent = 'Làm lại';
            checkAllBtn.onclick = () => window.location.reload();

            document.querySelectorAll('.suggest-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openSuggestionModal(e.target.dataset.id));
            });
        }

        function openSuggestionModal(questionId) {
            currentEditingQuestionId = parseInt(questionId, 10);
            const question = quizData.find(q => q.id === currentEditingQuestionId);
            if (!question) return;

            modal.style.display = 'flex';
            document.getElementById('new-answer').value = question.answer;
            document.getElementById('new-explanation').value = question.explanation;
        }

        function closeSuggestionModal() {
            modal.style.display = 'none';
            currentEditingQuestionId = null;
        }

        async function submitSuggestion() {
            if (!currentEditingQuestionId) return;
            const question = quizData.find(q => q.id === currentEditingQuestionId);

            const payload = {
                quiz_filename: 's---aaa.json',
                question_id: question.id,
                new_answer: document.getElementById('new-answer').value,
                new_explanation: document.getElementById('new-explanation').value
            };

            try {
                const response = await fetch('/suggest-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) closeSuggestionModal();
            } catch (error) {
                console.error('Lỗi khi gửi góp ý:', error);
                alert('Đã xảy ra lỗi khi gửi góp ý của bạn.');
            }
        }

        function attachEventListeners() {
            checkAllBtn.addEventListener('click', checkAllAnswers);
            closeModalBtn.addEventListener('click', closeSuggestionModal);
            submitSuggestionBtn.addEventListener('click', submitSuggestion);
            window.addEventListener('click', (event) => { if (event.target == modal) closeSuggestionModal(); });

            document.querySelectorAll('.check-single-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const questionId = parseInt(e.target.dataset.id, 10);
                    checkSingleAnswer(questionId);
                    // Gắn lại sự kiện cho nút suggest vừa được tạo
                    const suggestBtn = document.querySelector(`#exp-${questionId} .suggest-btn`);
                    if(suggestBtn) suggestBtn.addEventListener('click', (ev) => openSuggestionModal(ev.target.dataset.id));
                });
            });

            document.querySelectorAll('.copy-question-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const questionId = parseInt(e.target.dataset.id, 10);
                    const question = quizData.find(q => q.id === questionId);
                    if (!question) return;

                    let textToCopy = `Câu hỏi: ${question.question}\n`;
                    const sortedOptions = Object.keys(question.options).sort();
                    for (const key of sortedOptions) {
                        textToCopy += `${key}. ${question.options[key]}\n`;
                    }

                    navigator.clipboard.writeText(textToCopy).then(() => {
                        e.target.innerText = 'Đã copy!';
                        setTimeout(() => { e.target.innerText = 'Copy'; }, 2000);
                    }).catch(err => {
                        console.error('Không thể copy: ', err);
                    });
                });
            });
        }

        // Bắt đầu tải và render quiz khi trang được mở
        window.onload = loadAndRenderQuiz;
    </script>
</body>
</html>